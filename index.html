<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elvensong Campaign - World Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .leaflet-popup-content-wrapper {
            background: #2d2d44;
            color: #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .leaflet-popup-content {
            margin: 12px 16px;
        }

        .leaflet-popup-tip {
            background: #2d2d44;
        }

        .popup-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #7eb8da;
            margin-bottom: 8px;
        }

        .popup-type {
            font-size: 0.85em;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .popup-link {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: #4a5568;
            color: #e0e0e0;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .popup-link:hover {
            background: #5a6578;
        }

        /* Legend */
        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #2d2d44;
            padding: 15px;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.9em;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #7eb8da;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .legend-marker.city { background: #e74c3c; }
        .legend-marker.region { background: #2ecc71; }
        .legend-marker.location { background: #9b59b6; }
        .legend-marker.town { background: #f39c12; }

        /* Title overlay */
        .title-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2d44;
            padding: 12px 24px;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1.2em;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* Current location indicator */
        .current-location {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #2ecc71;
            padding: 6px 14px;
            border-radius: 20px;
            color: #1a1a2e;
            font-size: 0.85em;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Back link */
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #2d2d44;
            padding: 10px 16px;
            border-radius: 8px;
            color: #7eb8da;
            text-decoration: none;
            font-size: 0.9em;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: background 0.2s;
        }

        .back-link:hover {
            background: #3d3d54;
        }

        /* Controls */
        .map-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .map-btn {
            background: #2d2d44;
            color: #e0e0e0;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: background 0.2s;
        }

        .map-btn:hover {
            background: #3d3d54;
        }

        .map-btn.active {
            background: #e74c3c;
            color: white;
        }

        /* Edit Mode Panel */
        .edit-panel {
            display: none;
            position: fixed;
            top: 120px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 200px);
            background: #2d2d44;
            border-radius: 8px;
            color: #e0e0e0;
            z-index: 1001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .edit-panel.visible {
            display: block;
        }

        .edit-panel-header {
            padding: 12px 16px;
            background: #3d3d54;
            border-bottom: 1px solid #4d4d64;
        }

        .edit-panel-header h3 {
            color: #7eb8da;
            margin-bottom: 8px;
        }

        .edit-panel-header p {
            font-size: 0.85em;
            color: #a0a0a0;
        }

        .edit-panel-content {
            padding: 12px 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .coord-display {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .edit-panel-actions {
            padding: 12px 16px;
            border-top: 1px solid #4d4d64;
            display: flex;
            gap: 8px;
        }

        .edit-panel-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .btn-primary {
            background: #2ecc71;
            color: #1a1a2e;
        }

        .btn-secondary {
            background: #4a5568;
            color: #e0e0e0;
        }

        /* Add marker form */
        .add-marker-form {
            display: none;
            padding: 12px 16px;
            border-top: 1px solid #4d4d64;
        }

        .add-marker-form.visible {
            display: block;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 0.85em;
            color: #a0a0a0;
            margin-bottom: 4px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #4d4d64;
            border-radius: 4px;
            background: #1a1a2e;
            color: #e0e0e0;
            font-size: 0.9em;
        }

        /* Edit mode indicator */
        .edit-mode-banner {
            display: none;
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            padding: 6px 14px;
            border-radius: 20px;
            color: white;
            font-size: 0.85em;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .edit-mode-banner.visible {
            display: block;
        }

        body.edit-mode .current-location {
            display: none;
        }

        /* Marker list in edit panel */
        .marker-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .marker-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin: 4px 0;
            background: #1a1a2e;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .marker-list-item .name {
            flex: 1;
        }

        .marker-list-item .coords {
            color: #a0a0a0;
            font-family: monospace;
            font-size: 0.8em;
        }

        .marker-list-item .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 8px;
            font-size: 0.75em;
        }

        /* Mobile adjustments */
        @media (max-width: 600px) {
            .title-overlay {
                font-size: 1em;
                padding: 8px 16px;
                top: 10px;
            }
            .current-location, .edit-mode-banner {
                top: 55px;
                font-size: 0.75em;
            }
            .back-link {
                top: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            .legend {
                bottom: 10px;
                left: 10px;
                padding: 10px;
                font-size: 0.8em;
            }
            .edit-panel {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <a href="https://publish.obsidian.md/elvensong" class="back-link">‚Üê Back to Campaign</a>
    <div class="title-overlay">Elvensong Campaign - World of Gryth</div>
    <div class="current-location">üìç Current: Treston</div>
    <div class="edit-mode-banner">‚úèÔ∏è EDIT MODE - Drag markers to reposition</div>

    <div class="legend">
        <h4>Legend</h4>
        <div class="legend-item"><span class="legend-marker city"></span> Cities</div>
        <div class="legend-item"><span class="legend-marker region"></span> Regions</div>
        <div class="legend-item"><span class="legend-marker location"></span> Locations</div>
        <div class="legend-item"><span class="legend-marker town"></span> Towns</div>
    </div>

    <div class="map-controls">
        <button class="map-btn" onclick="goToCurrentLocation()">üìç Current Location</button>
        <button class="map-btn" onclick="showFullMap()">üó∫Ô∏è Full Map</button>
        <button class="map-btn" id="editModeBtn" onclick="toggleEditMode()">‚úèÔ∏è Edit Mode</button>
    </div>

    <!-- Edit Mode Panel -->
    <div class="edit-panel" id="editPanel">
        <div class="edit-panel-header">
            <h3>‚úèÔ∏è Edit Mode</h3>
            <p>Drag markers to reposition. Right-click map to add new markers.</p>
        </div>
        <div class="edit-panel-content">
            <div class="coord-display" id="coordDisplay">
                Click on map to see coordinates
            </div>
            <h4 style="margin-bottom: 8px; color: #7eb8da;">Markers</h4>
            <div class="marker-list" id="markerList"></div>
        </div>
        <div class="add-marker-form" id="addMarkerForm">
            <h4 style="margin-bottom: 10px; color: #7eb8da;">Add New Marker</h4>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="newMarkerName" placeholder="e.g., City - Newtown">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="newMarkerType">
                    <option value="city">City</option>
                    <option value="town">Town</option>
                    <option value="region">Region</option>
                    <option value="location">Location</option>
                </select>
            </div>
            <div class="form-group">
                <label>Position (click on map first)</label>
                <input type="text" id="newMarkerCoords" readonly placeholder="Right-click on map to set position">
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn-primary" onclick="addNewMarker()" style="flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer;">Add Marker</button>
                <button class="btn-secondary" onclick="cancelAddMarker()" style="flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            </div>
        </div>
        <div class="edit-panel-actions">
            <button class="btn-primary" onclick="exportMarkers()">üìã Copy Marker Data</button>
            <button class="btn-secondary" onclick="toggleEditMode()">Done</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==== CONFIGURATION ====
        const PUBLISH_BASE_URL = 'https://publish.obsidian.md/elvensong/';
        const MAP_IMAGE_URL = './World Map.jpg';

        // Image is 8192x8192 pixels (square)
        const IMG_WIDTH = 8192;
        const IMG_HEIGHT = 8192;

        // ==== CURRENT CAMPAIGN LOCATION ====
        // Update this as the party moves!
        const CURRENT_LOCATION = {
            name: "Treston",
            x: 1734,
            y: 2153,
            zoom: 0
        };

        // ==== MARKER DATA ====
        // Coordinates are in pixels on the 8192x8192 image
        // x = horizontal position from left edge
        // y = vertical position from TOP edge (will be converted for Leaflet)
        let markers = [
            { name: "City - Treston", type: "city", x: 1734, y: 2153 },
            { name: "City - Silverwall", type: "city", x: 2303, y: 2008 },
            { name: "City - Shafthield", type: "city", x: 1490, y: 2185 },
            { name: "City - Treeheart", type: "city", x: 2011, y: 2272 },
            { name: "City - Shugwood", type: "city", x: 2050, y: 7876 },
            { name: "City - Irus-Halls", type: "city", x: 3401, y: 7344 },
            { name: "City - Ustraga", type: "city", x: 1230, y: 1205 },
            { name: "Region - High Vel'Nora", type: "region", x: 4100, y: 3335 },
            { name: "Region - Eros", type: "region", x: 3249, y: 4353 },
            { name: "Region - Alkan", type: "region", x: 932, y: 2280 },
            { name: "Region - Q'Shar", type: "region", x: 7216, y: 4467 },
            { name: "Region - The Thornmark", type: "region", x: 2450, y: 1386 },
            { name: "Region - The Deadmoors", type: "region", x: 1781, y: 1585 },
            { name: "Region - Eldvale", type: "region", x: 1127, y: 1121 },
            { name: "Region - The Discovery Coast", type: "region", x: 2799, y: 1833 },
            { name: "Region - Silvaria", type: "region", x: 1941, y: 2425 },
            { name: "Region - Glaszar", type: "region", x: 2003, y: 1026 },
            { name: "Town - Beren-on-Lake", type: "town", x: 1869, y: 2093 },
            { name: "Location - Grey Rock Isle", type: "location", x: 1601, y: 2679 }
        ];

        // ==== STATE ====
        let editMode = false;
        let markerLayers = [];
        let pendingMarkerCoords = null;

        // ==== MARKER ICONS ====
        const createIcon = (color, isCurrentLocation = false) => L.divIcon({
            className: 'custom-marker',
            html: `<svg width="32" height="48" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">
                <path fill="${color}" stroke="${isCurrentLocation ? '#FFD700' : '#fff'}" stroke-width="${isCurrentLocation ? '3' : '1.5'}" d="M12.5 0C5.6 0 0 5.6 0 12.5c0 10.9 12.5 28.5 12.5 28.5S25 23.4 25 12.5C25 5.6 19.4 0 12.5 0z"/>
                <circle fill="#fff" cx="12.5" cy="12.5" r="5"/>
            </svg>`,
            iconSize: [32, 48],
            iconAnchor: [16, 48],
            popupAnchor: [0, -45]
        });

        const icons = {
            city: createIcon('#e74c3c'),
            region: createIcon('#2ecc71'),
            location: createIcon('#9b59b6'),
            town: createIcon('#f39c12'),
            current: createIcon('#e74c3c', true)
        };

        // ==== COORDINATE CONVERSION ====
        // Convert from image pixels (y from top) to Leaflet coords (y from bottom)
        function toLeaflet(x, y) {
            return [IMG_HEIGHT - y, x];
        }

        // Convert from Leaflet coords back to image pixels
        function fromLeaflet(lat, lng) {
            return { x: Math.round(lng), y: Math.round(IMG_HEIGHT - lat) };
        }

        // ==== INITIALIZE MAP ====
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -3,
            maxZoom: 2,
            zoomSnap: 0.25,
            zoomDelta: 0.5
        });

        // Image bounds in Leaflet coordinates
        const imageBounds = [[0, 0], [IMG_HEIGHT, IMG_WIDTH]];
        L.imageOverlay(MAP_IMAGE_URL, imageBounds).addTo(map);

        // Set max bounds with some padding
        map.setMaxBounds([[-500, -500], [IMG_HEIGHT + 500, IMG_WIDTH + 500]]);

        // Set initial view centered on current location
        const startPos = toLeaflet(CURRENT_LOCATION.x, CURRENT_LOCATION.y);
        map.setView(startPos, CURRENT_LOCATION.zoom);

        // ==== ADD MARKERS ====
        function createMarkers() {
            // Clear existing markers
            markerLayers.forEach(m => map.removeLayer(m));
            markerLayers = [];

            markers.forEach((marker, index) => {
                const isCurrentLocation = marker.name.includes(CURRENT_LOCATION.name);
                const icon = isCurrentLocation ? icons.current : (icons[marker.type] || icons.location);
                const displayName = marker.name.replace(/^(City|Region|Town|Location) - /, '');
                const typeLabel = marker.type.charAt(0).toUpperCase() + marker.type.slice(1);

                // Build Obsidian Publish URL
                const notePath = marker.name.replace(/ /g, '+');
                let folder = '';
                if (marker.type === 'city') folder = 'Cities/';
                else if (marker.type === 'region') folder = 'Regions/';
                else if (marker.type === 'town') folder = 'Towns/';
                else if (marker.type === 'location') folder = 'Locations/';

                const noteUrl = PUBLISH_BASE_URL + folder + notePath;

                const popupContent = `
                    <div class="popup-title">${displayName}${isCurrentLocation ? ' üìç' : ''}</div>
                    <div class="popup-type">${typeLabel}${isCurrentLocation ? ' ‚Ä¢ Current Location' : ''}</div>
                    <a href="${noteUrl}" target="_blank" class="popup-link">View Details ‚Üí</a>
                `;

                // Convert to Leaflet coordinates
                const pos = toLeaflet(marker.x, marker.y);

                const m = L.marker(pos, {
                    icon: icon,
                    draggable: editMode
                })
                    .bindPopup(popupContent)
                    .bindTooltip(displayName + (isCurrentLocation ? ' (You are here)' : ''), {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -45]
                    })
                    .addTo(map);

                // Handle drag end in edit mode
                m.on('dragend', function(e) {
                    const newPos = e.target.getLatLng();
                    const pixelCoords = fromLeaflet(newPos.lat, newPos.lng);
                    markers[index].x = pixelCoords.x;
                    markers[index].y = pixelCoords.y;
                    updateMarkerList();
                    document.getElementById('coordDisplay').innerHTML =
                        `<strong>${marker.name}</strong><br>Moved to: x: ${pixelCoords.x}, y: ${pixelCoords.y}`;
                });

                markerLayers.push(m);
            });
        }

        createMarkers();

        // ==== EDIT MODE ====
        function toggleEditMode() {
            editMode = !editMode;
            document.body.classList.toggle('edit-mode', editMode);
            document.getElementById('editModeBtn').classList.toggle('active', editMode);
            document.getElementById('editPanel').classList.toggle('visible', editMode);
            document.querySelector('.edit-mode-banner').classList.toggle('visible', editMode);

            // Recreate markers with new draggable state
            createMarkers();
            updateMarkerList();
        }

        function updateMarkerList() {
            const list = document.getElementById('markerList');
            list.innerHTML = markers.map((m, i) => `
                <div class="marker-list-item">
                    <span class="name">${m.name.replace(/^(City|Region|Town|Location) - /, '')}</span>
                    <span class="coords">x:${m.x} y:${m.y}</span>
                    <button class="delete-btn" onclick="deleteMarker(${i})">√ó</button>
                </div>
            `).join('');
        }

        function deleteMarker(index) {
            if (confirm(`Delete ${markers[index].name}?`)) {
                markers.splice(index, 1);
                createMarkers();
                updateMarkerList();
            }
        }

        // ==== ADD NEW MARKER ====
        map.on('contextmenu', function(e) {
            if (!editMode) return;

            const pixelCoords = fromLeaflet(e.latlng.lat, e.latlng.lng);
            pendingMarkerCoords = pixelCoords;

            document.getElementById('addMarkerForm').classList.add('visible');
            document.getElementById('newMarkerCoords').value = `x: ${pixelCoords.x}, y: ${pixelCoords.y}`;
            document.getElementById('newMarkerName').value = '';
            document.getElementById('newMarkerName').focus();
        });

        function addNewMarker() {
            const name = document.getElementById('newMarkerName').value.trim();
            const type = document.getElementById('newMarkerType').value;

            if (!name) {
                alert('Please enter a name');
                return;
            }
            if (!pendingMarkerCoords) {
                alert('Please right-click on the map to set position');
                return;
            }

            markers.push({
                name: name,
                type: type,
                x: pendingMarkerCoords.x,
                y: pendingMarkerCoords.y
            });

            createMarkers();
            updateMarkerList();
            cancelAddMarker();
        }

        function cancelAddMarker() {
            document.getElementById('addMarkerForm').classList.remove('visible');
            pendingMarkerCoords = null;
        }

        // ==== EXPORT MARKERS ====
        function exportMarkers() {
            const code = `const markers = [\n${markers.map(m =>
                `    { name: "${m.name}", type: "${m.type}", x: ${m.x}, y: ${m.y} }`
            ).join(',\n')}\n];`;

            navigator.clipboard.writeText(code).then(() => {
                alert('Marker data copied to clipboard! Paste this into the index.html file to save your changes.');
            }).catch(() => {
                // Fallback for browsers that don't support clipboard API
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Marker data copied to clipboard! Paste this into the index.html file to save your changes.');
            });
        }

        // ==== SHOW COORDINATES ON CLICK ====
        map.on('click', function(e) {
            if (!editMode) return;
            const pixelCoords = fromLeaflet(e.latlng.lat, e.latlng.lng);
            document.getElementById('coordDisplay').innerHTML =
                `Click position:<br><strong>x: ${pixelCoords.x}, y: ${pixelCoords.y}</strong>`;
        });

        // ==== CONTROL FUNCTIONS ====
        function goToCurrentLocation() {
            const pos = toLeaflet(CURRENT_LOCATION.x, CURRENT_LOCATION.y);
            map.setView(pos, CURRENT_LOCATION.zoom, {
                animate: true,
                duration: 0.5
            });
        }

        function showFullMap() {
            map.fitBounds(imageBounds, {
                animate: true,
                duration: 0.5,
                padding: [20, 20]
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return; // Don't trigger while typing

            if (e.key === 'r' || e.key === 'R') {
                showFullMap();
            }
            if (e.key === 'c' || e.key === 'C') {
                goToCurrentLocation();
            }
            if (e.key === 'e' || e.key === 'E') {
                toggleEditMode();
            }
            if (e.key === 'Escape' && editMode) {
                cancelAddMarker();
            }
        });
    </script>
</body>
</html>
